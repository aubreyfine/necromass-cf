name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Python (conda) ----------
      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: necromass-cf
          environment-file: env/environment.yml
          auto-activate-base: false
          use-mamba: true

      - name: Python session info
        shell: bash -l {0}
        run: |
          python -V
          python -c "import sys; print(sys.executable)"
          python - <<'PY'
import importlib
for m in ["numpy","pandas","SALib","scipy","matplotlib","statsmodels"]:
    try:
        mod = importlib.import_module(m)
        print(m, getattr(mod, "__version__", ""))
    except Exception as e:
        print("Missing:", m, e)
PY

      # ---------- R + renv ----------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3.2"

      - name: Restore R packages with renv
        uses: r-lib/actions/setup-renv@v2
        with:
          cache-version: 1

      # ---------- Lightweight smoke test ----------
      # Keep CI fast and resilient even if scripts aren't added yet.
      - name: Run lightweight checks
        shell: bash -l {0}
        run: |
          Rscript -e "cat('R session OK\\n'); if (file.exists('analysis/R/00_setup.R')) source('analysis/R/00_setup.R')"
          if [ -f analysis/R/10_traits_variation.R ]; then Rscript analysis/R/10_traits_variation.R; else echo 'Skip R figure script'; fi
          if [ -f analysis/python/sobol_run.py ]; then python analysis/python/sobol_run.py --smoke || true; else echo 'Skip Python Sobol script'; fi

      # ---------- Collect any outputs if present ----------
      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            analysis/figures/**/*.png
            analysis/figures/**/*.pdf
            supplement/tables/**/*.csv
          if-no-files-found: ignore
