name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Python (conda) ----------
      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: necromass-cf
          environment-file: env/environment.yml
          auto-activate-base: false
          use-mamba: true

      - name: Python session info
        shell: bash -l {0}
        run: |
          python -V
          python -c "import sys; print('Python:', sys.executable)"
          python -c "import numpy, pandas, scipy, matplotlib, statsmodels; print('Py deps OK')"

      # ---------- R + renv ----------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3.2"

      # Only run renv restore if renv.lock exists
      - name: Restore R packages with renv
        if: ${{ hashFiles('renv.lock') != '' }}
        uses: r-lib/actions/setup-renv@v2
        with:
          cache-version: 1

      # ---------- Lightweight smoke test ----------
      - name: Run lightweight checks
        shell: bash -l {0}
        run: |
          Rscript -e "cat('R session OK\\n'); sessionInfo()"
          if [ -f analysis/R/00_setup.R ]; then Rscript analysis/R/00_setup.R; else echo 'Skip 00_setup.R'; fi
          if [ -f analysis/R/10_traits_variation.R ]; then Rscript analysis/R/10_traits_variation.R || true; else echo 'Skip traits script'; fi
          if [ -f analysis/python/sobol_run.py ]; then python analysis/python/sobol_run.py --smoke || true; else echo 'Skip sobol'; fi

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            analysis/figures/**/*.png
            analysis/figures/**/*.pdf
            supplement/tables/**/*.csv
          if-no-files-found: ignore
